<div class="ticket-info">
  <a (click)="onBack()" style="color: #48afe5">
    <mat-icon inline="true">arrow_back</mat-icon> Back to TRM home
  </a>
  <app-ticket-status [dispute]="disputeInfo" *ngIf="disputeInfo"></app-ticket-status>
  <div class="ticket-info-section">
    <mat-expansion-panel [expanded]="true">
      <mat-expansion-panel-header (click)="handleCollapse('ticketInformation')">
        <app-page-header>
          <ng-container subHeader>
            <span>Ticket Information </span>
            <i *ngIf="collapseObj?.ticketInformation" class="fa fa-minus-circle"
              style="font-size:18px; color:#009cde"></i>
            <i *ngIf="!collapseObj?.ticketInformation" class="fa fa-plus-circle"
              style="font-size:18px; color:#009cde"></i>
          </ng-container>
        </app-page-header>
      </mat-expansion-panel-header>
      <div class="ticket-body">
        <div style="display: flex; justify-content: space-evenly">

          <section class="mb-2 img-section" [style.width]="disableForm ? '25%' : '20%'">
            <div *ngIf="!disableForm">
              <ng-container subHeader>
                <h3>Ticket Image</h3>
              </ng-container>
            </div>
            <div *ngIf="disableForm==true" data-toggle="modal" data-target="#exampleModal" width="280 !important">
              <!-- <img src="../../../assets/violation-ticket-sample.jpg" width="280" height="500"><br /> -->
              <img [src]="imageToShow" width="280" height="500"><br />
              <span style="font-size:15px; color:#009cde; align-content: center;" width="280">
                <i class="fa fa-plus-circle" style="font-size:18px; color:#009cde"></i>
                <strong> Click to expand ticket image</strong>
              </span>
            </div>
            <div *ngIf="disableForm==false" data-toggle="modal" data-target="#exampleModal" width="150 !important">
              <!-- <img src="../../../assets/violation-ticket-sample.jpg" width="150" height="200"><br /> -->
              <img [src]="imageToShow" width="150" height="200"><br />
              <span style="font-size:10px; color:#009cde; align-content: center;" width="150">
                <i class="fa fa-plus-circle" style="font-size:18px; color:#009cde"></i>
                <strong> Click to expand ticket image</strong>
              </span>
            </div>
          </section>
          <section [ngClass]="!disableForm? 'ticket-section-form':''" class="mb-2"
            [style.width]="!disableForm ? '48%' : '62%'">
            <form (ngSubmit)="onSubmit()" [formGroup]="form" novalidate>

              <div class="row">
                <div *ngIf="!disableForm">
                  <ng-container subHeader>
                    <span><h3>Violation Ticket Details</h3></span>
                  </ng-container>
                </div>
                <section>
                  <div class="row">
                    <div class="col-lg-4">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100 mb-2">
                        <mat-label *ngIf="disableForm">Violation ticket number</mat-label>
                        <mat-label *ngIf="!disableForm">Ticket number</mat-label>
                        <input formControlName="ticketNumber" matInput [readonly]="disableForm==true" type="text"
                          oninput="this.value = this.value.toUpperCase()" mask="SS00000000" autocomplete="off" />
                        <mat-error *ngIf="form.get('ticketNumber').hasError('required')">
                          {{ "error.required" | translate }}
                        </mat-error>
                        <mat-error *ngIf="form.get('ticketNumber').value && form.get('ticketNumber').hasError('mask')">
                          This ticket number is not valid. It must be 2 letters and 8 numbers.
                        </mat-error>
                      </mat-form-field>
                    </div>

                    <div class="col-lg-4">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100">
                        <mat-label *ngIf="disableForm">Violation date</mat-label>
                        <mat-label *ngIf="!disableForm">Date</mat-label>
                        <input matInput [readonly]="disableForm" type="date" placeholder="yyyy-MM-DD" formControlName="violationDate" [max]="todayDate" />
                        <mat-error *ngIf="form.get('violationDate').hasError('required')">
                          {{ "error.required" | translate }}
                        </mat-error>
                      </mat-form-field>
                    </div>

                    <div class="col-lg-4">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100">
                        <mat-label *ngIf="disableForm">Violation time</mat-label>
                        <mat-label *ngIf="!disableForm">Time</mat-label>
                        <input matInput [readonly]="disableForm" type="text" mask="00:00" formControlName="violationTime" />
                        <mat-error *ngIf="form.get('violationTime').hasError('required')">
                          {{ "error.required" | translate }}</mat-error>
                        <mat-error *ngIf="form.get('violationTime').hasError('pattern')">
                           Invalid time. Use 24hr format.
                        </mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                </section>
                <section>
                  <ng-container subHeader>
                    <span> <h3>Personal Information</h3> </span>
                  </ng-container>
                  <div class="row">
                    <div class="col-lg-6">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100">
                        <mat-label>Surname</mat-label>
                        <input matInput [readonly]="disableForm" formControlName="surname" />
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                    <div class="col-lg-6">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100">
                        <mat-label>Given names</mat-label>
                        <input matInput [readonly]="disableForm" formControlName="givenNames" />
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-lg-6">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100">
                        <mat-label>Province/State of driver's licence</mat-label>
                          <input matInput readonly="true" formControlName="driversLicenceProvince" *ngIf="disableForm==true" />
                          <mat-select formControlName="driversLicenceProvince" (selectionChange)="onDLProvinceChange($event.value)" *ngIf="disableForm==false">
                            <mat-optgroup label="Disputant Input">
                              <mat-option [value]="initialDisputeValues.driversLicenceProvince">{{ initialDisputeValues.driversLicenceProvince }}</mat-option>
                            </mat-optgroup>
                            <mat-optgroup label="Canada">
                              <mat-option *ngFor="let province of provinces" [value]="province.name">{{ province.name }}</mat-option>
                            </mat-optgroup>
                            <mat-optgroup label="United States">
                              <mat-option *ngFor="let state of states" [value]="state.name">{{ state.name }}</mat-option>
                            </mat-optgroup>
                          </mat-select>
                          <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>

                    <div class="col-lg-6">
                     <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100" *ngIf="form.get('driversLicenceProvince').value == 'British Columbia'">
                        <mat-label>Driver's licence number</mat-label>
                        <input matInput formControlName="driversLicenceNumber" minlength="7" maxlength="9" (keypress)="onKeyPressNumbers($event)" [readonly]="disableForm" autocomplete="off"/>
                        <mat-error *ngIf="form.get('driversLicenceNumber').hasError('required')">{{ "error.required" | translate }}</mat-error>
                        <mat-error 
                          *ngIf="
                            form.get('driversLicenceNumber').hasError('pattern') ||
                            form.get('driversLicenceNumber').hasError('minlength') ||
                            form.get('driversLicenceNumber').hasError('maxlength')">
                          Must be a valid BC driver's license number of seven to nine digits
                        </mat-error>
                      </mat-form-field>
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100" *ngIf="form.get('driversLicenceProvince').value != 'British Columbia'">
                        <mat-label>Driver's licence number</mat-label>
                        <input matInput formControlName="driversLicenceNumber" [readonly]="disableForm" autocomplete="off"/>
                        <mat-error *ngIf="form.get('driversLicenceNumber').hasError('required')">{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                </section>
                <section>
                  <ng-container subHeader>
                    <span> <h3>Count 1</h3></span>
                  </ng-container>
                  <div class="row">
                    <div class="col-lg-8">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100">
                        <mat-label>Section / Act / Description </mat-label>
                        <input matInput formControlName="count1Description" [readonly]="disableForm==true" [matAutocomplete]="auto" [matTooltip]="form.get('count1Description').value"/>
                        <mat-autocomplete #auto="matAutocomplete" panelWidth="750">
                          <mat-option [value]="getCountLegalParagraphing(1, initialDisputeValues.violationTicket)">{{ getCountLegalParagraphing(1, initialDisputeValues.violationTicket) }}</mat-option>
                          <mat-option *ngFor="let statute of filteredCount1Statutes | async" [value]="statute.statuteString">{{ statute.statuteString }}</mat-option>
                        </mat-autocomplete>
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                    <div class="col-lg-4">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100">
                        <mat-label>Fine amount ($)</mat-label>
                        <input matInput [readonly]="disableForm" formControlName="count1TicketedAmount" />
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                </section>
                <section>
                  <ng-container subHeader>
                    <span> <h3>Count 2</h3></span>
                  </ng-container>
                  <div class="row">
                    <div class="col-lg-8">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100">
                        <mat-label>Section / Act / Description </mat-label>
                        <input matInput formControlName="count2Description" [readonly]="disableForm==true" [matAutocomplete]="auto2" [matTooltip]="form.get('count2Description').value" />
                        <mat-autocomplete #auto2="matAutocomplete" panelWidth="750">
                          <mat-option [value]="getCountLegalParagraphing(2, initialDisputeValues.violationTicket)">{{ getCountLegalParagraphing(2, initialDisputeValues.violationTicket) }}</mat-option>
                          <mat-option *ngFor="let statute of filteredCount2Statutes | async" [value]="statute.statuteString">{{ statute.statuteString }}</mat-option>
                        </mat-autocomplete>
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                    <div class="col-lg-4">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100">
                        <mat-label>Fine amount ($)</mat-label>
                        <input matInput [readonly]="disableForm" formControlName="count2TicketedAmount" />
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                </section>
                <section>
                  <ng-container subHeader>
                    <span><h3>Count 3</h3></span>
                  </ng-container>
                  <div class="row">
                    <div class="col-lg-8">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100">
                        <mat-label>Section / Act / Description </mat-label>
                        <input matInput formControlName="count3Description" [readonly]="disableForm==true" [matAutocomplete]="auto3" [matTooltip]="form.get('count3Description').value" />
                        <mat-autocomplete #auto3="matAutocomplete" panelWidth="750">
                          <mat-option [value]="getCountLegalParagraphing(3, initialDisputeValues.violationTicket)">{{ getCountLegalParagraphing(3, initialDisputeValues.violationTicket) }}</mat-option>
                          <mat-option *ngFor="let statute of filteredCount3Statutes | async" [value]="statute.statuteString">{{ statute.statuteString }}</mat-option>
                        </mat-autocomplete>
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                    <div class="col-lg-4">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100">
                        <mat-label>Fine amount ($)</mat-label>
                        <input matInput [readonly]="disableForm" formControlName="count3TicketedAmount" />
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                </section>
                <section>
                  <ng-container subHeader>
                    <span> <h3>Court Location</h3> </span>
                  </ng-container>
                  <div class="row">
                    <div class="col-lg-9">
                      <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100">
                        <input matInput readonly="true" formControlName="provincialCourtHearingLocation" *ngIf="disableForm==true" />
                        <mat-select formControlName="provincialCourtHearingLocation" *ngIf="disableForm==false">
                          <mat-option [value]="initialDisputeValues.provincialCourtHearingLocation">{{ initialDisputeValues.provincialCourtHearingLocation }}</mat-option>
                          <mat-option *ngFor="let courtLocation of courtLocations" [value]="courtLocation.name">{{ courtLocation.name }}</mat-option>
                        </mat-select>
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                </section>
                <div class="col">
                  <button *ngIf="!showOCR" class="dangerButton btn btn-danger" mat-flat-button
                    style=" background-color: rgb(201, 32, 32); color: white;float: right;" type="button" color="red"
                    class="large" (click)="showOCR = !showOCR">
                    FLAGGED FIELDS - Validation required
                  </button>
                  <button *ngIf="showOCR" class="btn btn-primary" mat-flat-button
                    style=" background-color: #003366; color: white;float: right;" type="button" color="red"
                    class="large" (click)="editForm()">
                    Edit fields
                  </button>
                </div>
              </div>
            </form>
          </section>
          <section class="mb-2" *ngIf="showOCR" [style.width]="!disableForm ? '20%' : '0%'">
            <form (ngSubmit)="onSubmit()" [formGroup]="flagsForm" novalidate>
              <div class="row">
                <ng-container subHeader>
                  <span> <h3>Citizen flags</h3> </span>
                </ng-container>
              <div class="row">
                <div class="col-lg-12">
                  <mat-form-field [ngClass]="!disableForm? 'border-form':''" class="w-100 mb-2">
                    <mat-label>Description of differences</mat-label>
                    <input formControlName="disputantOcrIssuesDescription" matInput type="text" autocomplete="off" />
                  </mat-form-field>
                </div>
              </div>
              <div class="row">
                <ng-container subHeader>
                  <h3>System flags</h3>
                </ng-container>
                <div class="col-lg-12">
                  <p class="systemFlagList"><span class="dot"></span><span class="success">95%</span>-Violation ticket
                    number </p>
                  <p class="systemFlagList"><span class="dot"></span><span class="success">95%</span>-Violation date
                  </p>
                  <p class="systemFlagList"><span class="dot"></span><span class="success">95%</span>-Violation time
                  </p>
                  <p class="systemFlagList"><span class="dot"></span><span class="success">95%</span>-Surname </p>
                  <p class="systemFlagList"><span class="dot"></span><span class="success">95%</span>-Given Name </p>
                  <p class="systemFlagList"><span class="dot"></span><span class="success">95%</span>-Province/State of
                    driver's licence </p>
                  <p class="systemFlagList"><span class="dot-fail"></span><span class="fail">75%</span>-Driver's licence
                    number</p>
                </div>
              </div>
            </div>
          </form>
          </section>
        </div>
        <div class="contact-info" *ngIf="!showOCR">
          <mat-expansion-panel [expanded]="true">
            <mat-expansion-panel-header (click)="handleCollapse('ticketInformation')">
              <app-page-header>
                <ng-container subHeader>
                  <span>Contact Information </span>
                  <i *ngIf="collapseObj?.contactInformation" class="fa fa-minus-circle"
                    style="font-size:18px; color:#009cde"></i>
                  <i *ngIf="!collapseObj?.contactInformation" class="fa fa-plus-circle"
                    style="font-size:18px; color:#009cde"></i>
                </ng-container>
              </app-page-header>

            </mat-expansion-panel-header>
            <div class="contact-body">
              <form (ngSubmit)="onSubmit()" [formGroup]="form" novalidate>
                <section class="mb-2" style="width: 66%;">
                  <div class="row">
                    <div class="col-md-6">
                      <mat-form-field class="w-100">
                        <mat-label>Surname</mat-label>
                        <input matInput [readonly]="disableForm" formControlName="surname" />
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                    <div class="col-md-6">
                      <mat-form-field class="w-100">
                        <mat-label>Given names</mat-label>
                        <input matInput [readonly]="disableForm" formControlName="givenNames" />
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                  </div>

                  <section>
                    <div class="row">
                      <div class="col-md-6">
                        <mat-form-field class="w-100">
                          <mat-label>Mailing address</mat-label>
                          <input matInput [readonly]="disableForm" formControlName="address" />
                          <mat-error>{{ "error.required" | translate }}</mat-error>
                        </mat-form-field>
                      </div>
                      <div class="col-md-6">
                        <mat-form-field class="w-100">
                          <mat-label>Country</mat-label>
                          <mat-select formControlName="country" [readonly]="disableForm">
                            <mat-option value="Canada">Canada</mat-option>
                            <mat-option value="USA">USA</mat-option>
                          </mat-select>
                          <mat-error>{{ "error.required" | translate }}</mat-error>
                        </mat-form-field>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6">
                        <mat-form-field class="w-100">
                          <mat-label>City</mat-label>
                          <input matInput [readonly]="disableForm" formControlName="city" />
                          <mat-error>{{ "error.required" | translate }}</mat-error>
                        </mat-form-field>
                      </div>
                      <div class="col-md-6">
                        <mat-form-field class="w-100">
                          <mat-label>Province</mat-label>
                          <mat-select formControlName="province" [readonly]="disableForm" *ngIf="form.get('country').value == 'Canada'">
                            <mat-option *ngFor="let province of provinces" [value]="province.name">{{ province.name }}</mat-option>
                          </mat-select>
                          <mat-select formControlName="province" [readonly]="disableForm" *ngIf="form.get('country').value == 'USA'">
                            <mat-option *ngFor="let state of states" [value]="state.name">{{ state.name }}</mat-option>
                          </mat-select>
                          <mat-error>{{ "error.required" | translate }}</mat-error>
                        </mat-form-field>
                      </div>
                    </div>
                  </section>

                  <div class="row">

                    <div class="col-md-6">
                      <mat-form-field class="w-100">
                        <mat-label>Postal code</mat-label>
                        <input matInput [readonly]="disableForm" mask="S0S 0S0"
                          oninput="this.value = this.value.toUpperCase()" formControlName="postalCode"
                          [showMaskTyped]="true" />
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                    <div class="col-md-6">
                      <mat-form-field class="w-100">
                        <mat-label>Birthdate</mat-label>
                        <input matInput [readonly]="disableForm" [matDatepicker]="picker"
                          formControlName="birthdate" readonly (click)="picker.open()" />
                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker [touchUi]="isMobile" startView="multi-year"></mat-datepicker>
                        <mat-error *ngIf="form.get('birthdate').hasError('required')">{{"error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <mat-form-field class="w-100">
                        <mat-label>Phone number</mat-label>
                        <input matInput [readonly]="disableForm" formControlName="homePhoneNumber" mask="(000) 000-0000"
                          [showMaskTyped]="true" />
                        <mat-error *ngIf="form.get('homePhoneNumber').hasError('required')">{{"error.required" | translate }}</mat-error>
                        <mat-error *ngIf="form.get('homePhoneNumber').hasError('phone')">Must be a valid phone number</mat-error>
                      </mat-form-field>
                    </div>
                    <div class="col-md-6">
                      <mat-form-field class="w-100">
                        <mat-label>Email address</mat-label>
                        <input matInput [readonly]="disableForm" formControlName="emailAddress" autocomplete="off" />
                        <mat-error *ngIf="form.get('emailAddress').hasError('required')">{{ "error.required" | translate }}</mat-error>
                        <mat-error *ngIf="form.get('emailAddress').hasError('email')">{{"error.email_address" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <mat-form-field class="w-100">
                        <mat-label>Driver's licence number</mat-label>
                        <input matInput [readonly]="disableForm" formControlName="driversLicenceNumber" mask="0000000"
                          [showMaskTyped]="false" />
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>

                    <div class="col-md-6">
                      <mat-form-field class="w-100">
                        <mat-label>Province/State of driver's licence</mat-label>
                        <input matInput [readonly]="disableForm" formControlName="driversLicenceProvince" />
                        <mat-error>{{ "error.required" | translate }}</mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                </section>
              </form>
              <div class="col offset-lg-6 col-lg-4" *ngIf="showOCR">
                <button id="primaryButton" mat-flat-button type="button" color="primary" class="large"
                  (click)="editForm()">
                  <strong>Edit Fields</strong>
                </button>
              </div>
            </div>
          </mat-expansion-panel>
        </div>
        <div *ngIf="showOCR" class="footer" style="align-items: center;">
          <hr />
          <button class="dangerButton" mat-flat-button
            style=" background-color: white; border: 1px solid #003366;margin-right: 2%;" type="button" color="red"
            class="large" (click)="onBack()">
            < Cancel and go back 
          </button>
          <button class="" mat-flat-button style=" background-color: green;color: white;" type="button" color="red"
            class="large">
            Confirm and validate ticket fields
          </button>
        </div>
      </div>
    </mat-expansion-panel>
  </div>
</div>

<div class="modal" id="exampleModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header" style="justify-content: flex-end;">
        <h1></h1>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="height: 800px; text-align: center;">
        <img [src]="imageToShow" width="450" height="750">
      </div>
    </div>
  </div>
</div>